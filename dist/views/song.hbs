<svg xmlns="http://www.w3.org/2000/svg" width="{{ width }}" height="{{ height }}">
    <foreignObject width="{{ width }}" height="{{ height }}">
        <link rel="stylesheet" href="/css/song.css" />
        <script
            src="https://code.jquery.com/jquery-3.7.1.js"
            integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
            crossorigin="anonymous">
        </script>
        <div class="cont">
            <img class="album-cover" src="{{ albumCoverURL }}" alt=""></img>
            <div class="song-details">
                <span class="song-title">{{ songTitle }}</span>
                <span class="song-artist">{{ songArtist }}</span>
            </div>
        </div>
        <span id="ruler"></span>
        <script type="text/javascript">
            const visualLength = (s, fontSize, fontWeight) => {
                return $("#ruler").css("fontSize", fontSize).css("fontWeight", fontWeight).html(s).get(0).offsetWidth;
            };

            const trimStringToVisualLength = (element, fontSize, fontWeight) => {
                $(element).toArray().forEach((e) => {
                    const lengthPixels = e.offsetWidth;
                    const s = $(e).html();
                    if (visualLength(s, fontSize) < lengthPixels) return s;
                
                    // in the future could do a binary search but kinda lazy rn :)
                    for (let l = s.length - 3; l > 0; l--) {
                        const substring = `${s.substring(0, l)}...`;
                        if (visualLength(substring, fontSize, fontWeight) < lengthPixels) {
                            $(e).html(substring);
                            return;
                        }
                    }
                });
            };

            $(document).ready(() => {
                trimStringToVisualLength(".song-title", "1rem", "600");
                trimStringToVisualLength(".song-artist", "0.8rem", "400");
            });

            {{ extraScript }}
        </script>
    </foreignObject>
</svg>